<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trifect Expense Tracker</title>
    <meta name="description" content="Personal expense tracking app with budget monitoring and spending analytics">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter+Display:wght@400;500;700&family=Inter:wght@400;700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        display: ['Inter Display', 'Inter', 'sans-serif'],
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            primary: '#b11f29',
                            bg: '#171717',
                            text: '#dbd6cb',
                        },
                        dark: {
                            900: '#171717',
                            800: '#1c1c1c',
                            700: '#222222',
                            600: '#2a2a2a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        h1,
        h2,
        h3,
        .font-display {
            font-family: 'Inter Display', 'Inter', sans-serif;
        }

        body {
            background: #171717;
            color: #dbd6cb;
        }

        .glass-card {
            background: linear-gradient(135deg, rgba(177, 31, 41, 0.08) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(177, 31, 41, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(219, 214, 203, 0.15);
            backdrop-filter: blur(10px);
        }

        .glass-input:focus {
            border-color: rgba(177, 31, 41, 0.6);
            box-shadow: 0 0 0 3px rgba(177, 31, 41, 0.2);
        }

        .gradient-text {
            background: linear-gradient(135deg, #b11f29, #e63946);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gradient-border {
            position: relative;
            background: linear-gradient(135deg, rgba(177, 31, 41, 0.2), rgba(230, 57, 70, 0.2));
        }

        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(135deg, #b11f29, #e63946);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        .animate-fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) backwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Enhanced hover with glow effect */
        .hover-scale {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }

        .hover-scale::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s ease;
            background: radial-gradient(circle at center, rgba(177, 31, 41, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .hover-scale:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 20px 50px rgba(177, 31, 41, 0.2), 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .hover-scale:hover::after {
            opacity: 1;
        }

        /* Floating animation for cards */
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-6px);
            }
        }

        /* Shimmer effect for loading states */
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        /* Progress bar with glow */
        .progress-bar {
            transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: visible;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: inherit;
            box-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
            animation: progressPulse 1.5s ease-in-out infinite;
        }

        @keyframes progressPulse {

            0%,
            100% {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }

            50% {
                opacity: 0.7;
                transform: translateY(-50%) scale(1.3);
            }
        }

        /* Button ripple effect */
        .btn-ripple {
            position: relative;
            overflow: hidden;
        }

        .btn-ripple::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn-ripple:active::before {
            width: 300px;
            height: 300px;
            opacity: 0;
        }

        /* Glowing border animation */
        .glow-border {
            position: relative;
        }

        .glow-border::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            padding: 2px;
            background: linear-gradient(45deg, #b11f29, #e63946, #b11f29, #e63946);
            background-size: 300% 300%;
            animation: glowRotate 4s linear infinite;
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .glow-border:hover::before {
            opacity: 1;
        }

        @keyframes glowRotate {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Staggered card animations */
        .stagger-1 {
            animation-delay: 0.05s;
        }

        .stagger-2 {
            animation-delay: 0.1s;
        }

        .stagger-3 {
            animation-delay: 0.15s;
        }

        .stagger-4 {
            animation-delay: 0.2s;
        }

        .stagger-5 {
            animation-delay: 0.25s;
        }

        .stagger-6 {
            animation-delay: 0.3s;
        }

        /* Row hover effect for table */
        .table-row-hover {
            transition: all 0.2s ease;
        }

        .table-row-hover:hover {
            background: rgba(177, 31, 41, 0.08);
            transform: scale(1.005);
        }

        /* Number counter animation */
        .animate-number {
            display: inline-block;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-number.updating {
            transform: scale(1.1);
            color: #b11f29;
        }

        /* Chart canvas entrance */
        .chart-enter {
            animation: chartEnter 0.8s cubic-bezier(0.16, 1, 0.3, 1) backwards;
        }

        @keyframes chartEnter {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Icon spin on hover */
        .icon-spin:hover svg {
            animation: iconSpin 0.5s ease;
        }

        @keyframes iconSpin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Delete button shake */
        .delete-shake:hover {
            animation: shake 0.4s ease;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-3px);
            }

            75% {
                transform: translateX(3px);
            }
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(177, 31, 41, 0.4);
            border-radius: 3px;
            transition: background 0.2s ease;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(177, 31, 41, 0.6);
        }

        .pulse-alert {
            animation: alertPulse 2s ease-in-out infinite;
        }

        @keyframes alertPulse {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 4px 20px rgba(177, 31, 41, 0.4);
            }

            50% {
                opacity: 0.9;
                box-shadow: 0 4px 30px rgba(177, 31, 41, 0.6);
            }
        }

        /* Modal backdrop blur animation */
        .modal-backdrop {
            animation: backdropIn 0.3s ease;
        }

        @keyframes backdropIn {
            from {
                backdrop-filter: blur(0);
                opacity: 0;
            }

            to {
                backdrop-filter: blur(8px);
                opacity: 1;
            }
        }

        @keyframes successFlash {

            0%,
            100% {
                background: transparent;
            }

            50% {
                background: rgba(177, 31, 41, 0.2);
            }
        }

        /* Chat Widget Styles */
        .chat-widget {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 50;
        }

        @media (max-width: 640px) {
            .chat-widget {
                bottom: 1rem;
                right: 1rem;
            }

            .chat-window {
                width: calc(100vw - 2rem) !important;
                max-width: 380px;
                right: -1rem !important;
            }
        }

        .chat-button {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            background: #b11f29;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(177, 31, 41, 0.4);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .chat-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(177, 31, 41, 0.5);
        }

        .chat-window {
            position: absolute;
            bottom: 5rem;
            right: 0;
            width: 380px;
            height: 500px;
            max-height: 80vh;
            background: #171717;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .chat-window.open {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }

        .chat-header {
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(177, 31, 41, 0.1), rgba(0, 0, 0, 0));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 1.25rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-size: 0.9375rem;
            line-height: 1.5;
        }

        .message.user {
            background: #b11f29;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.05);
            color: #dbd6cb;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .typing-indicator span {
            display: inline-block;
            width: 4px;
            height: 4px;
            background: #dbd6cb;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Custom select styling for better contrast */
        select option {
            background-color: #171717;
            color: #dbd6cb;
            padding: 10px;
        }

        /* Chart center absolute positioning fix */
        .chart-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-brand-bg text-brand-text min-h-screen">
    <!-- Alert Banner -->
    <div id="alertBanner" class="hidden fixed top-0 left-0 right-0 z-50 pulse-alert">
        <div class="bg-gradient-to-r from-red-600/90 to-orange-600/90 backdrop-blur-md py-3 px-6">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <span id="alertText" class="font-medium text-white"></span>
                </div>
                <button onclick="closeAlert()" class="text-white/80 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <header class="mb-8 animate-fade-in">
            <div class="flex flex-col gap-4">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div class="flex-1">
                        <h1 class="flex items-center gap-3 flex-wrap">
                            <img src="Trifect%20Media%20logo.png" alt="Trifect Media"
                                class="h-8 sm:h-10 w-auto object-contain">
                            <span class="text-2xl sm:text-3xl lg:text-4xl font-bold gradient-text">Expense
                                Tracker</span>
                        </h1>
                        <p class="text-brand-text/70 mt-1 text-sm sm:text-base">Monitor your spending & stay on budget
                        </p>
                    </div>
                    <select id="monthSelect" onchange="changeMonth()"
                        class="glass-input rounded-xl px-3 sm:px-4 py-2 sm:py-2.5 text-sm sm:text-base text-white focus:outline-none cursor-pointer bg-[#171717] border border-white/10 w-full sm:w-auto">
                    </select>
                </div>
                <div class="flex flex-wrap items-center gap-2 sm:gap-3">
                    <button onclick="openModal('accountModal'); renderAccountList()"
                        class="glass-card hover-scale glow-border icon-spin px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl text-brand-primary font-medium flex items-center gap-2 text-sm sm:text-base flex-1 sm:flex-initial justify-center">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                        </svg>
                        <span class="hidden xs:inline">Accounts</span>
                        <span class="xs:hidden">Accts</span>
                    </button>
                    <button onclick="openModal('categoryModal'); renderCategoryList()"
                        class="glass-card hover-scale glow-border icon-spin px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl text-brand-primary font-medium flex items-center gap-2 text-sm sm:text-base flex-1 sm:flex-initial justify-center">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                        </svg>
                        <span class="hidden xs:inline">Categories</span>
                        <span class="xs:hidden">Cats</span>
                    </button>
                    <button onclick="openModal('budgetModal')"
                        class="glass-card hover-scale glow-border icon-spin px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl text-brand-primary font-medium flex items-center gap-2 text-sm sm:text-base flex-1 sm:flex-initial justify-center">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="hidden xs:inline">Budgets</span>
                        <span class="xs:hidden">Budget</span>
                    </button>
                    <button onclick="openModal('transactionModal')"
                        class="bg-brand-primary hover:bg-red-700 px-3 sm:px-5 py-2 sm:py-2.5 rounded-xl font-medium flex items-center gap-2 transition-all hover-scale btn-ripple glow-border text-white text-sm sm:text-base flex-1 sm:flex-initial justify-center whitespace-nowrap">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span class="hidden xs:inline">Add Transaction</span>
                        <span class="xs:hidden">Add</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Budget Cards Grid -->
        <section class="mb-8 animate-fade-in" style="animation-delay: 0.1s">
            <h2 class="text-xl font-semibold mb-4 text-brand-text">Budget Overview</h2>
            <div id="budgetCardsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Budget cards will be inserted here -->
            </div>
        </section>

        <!-- Summary Cards with Sparklines -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 animate-slide-up" style="animation-delay: 0.1s;">
            <!-- Balance Card -->
            <div class="glass-card p-6 rounded-2xl relative overflow-hidden group hover-scale border border-white/5">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-400 text-sm font-medium uppercase tracking-wider">Total Balance</p>
                        <h3 class="text-3xl font-bold text-white mt-1" id="totalBalance">₹0</h3>
                    </div>
                    <div class="p-3 bg-blue-500/10 rounded-xl text-blue-400 border border-blue-500/20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                            </path>
                        </svg>
                    </div>
                </div>
                <!-- Sparkline -->
                <div class="relative h-16 w-full mask-linear-fade">
                    <canvas id="balanceSparkline"></canvas>
                </div>
            </div>

            <!-- Income Card -->
            <div class="glass-card p-6 rounded-2xl relative overflow-hidden group hover-scale border border-white/5">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-400 text-sm font-medium uppercase tracking-wider">Total Income</p>
                        <h3 class="text-3xl font-bold text-emerald-400 mt-1" id="totalIncome">₹0</h3>
                    </div>
                    <div class="p-3 bg-emerald-500/10 rounded-xl text-emerald-400 border border-emerald-500/20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                    </div>
                </div>
                <div class="relative h-16 w-full">
                    <canvas id="incomeSparkline"></canvas>
                </div>
            </div>

            <!-- Expenses Card -->
            <div class="glass-card p-6 rounded-2xl relative overflow-hidden group hover-scale border border-white/5">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-400 text-sm font-medium uppercase tracking-wider">Total Expenses</p>
                        <h3 class="text-3xl font-bold text-rose-400 mt-1" id="totalExpenseSummary">₹0</h3>
                    </div>
                    <div class="p-3 bg-rose-500/10 rounded-xl text-rose-400 border border-rose-500/20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                </div>
                <div class="relative h-16 w-full">
                    <canvas id="expenseSparkline"></canvas>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Donut Chart -->
            <div class="glass-card rounded-2xl p-6 hover-scale animate-fade-in" style="animation-delay: 0.2s">
                <h3 class="text-lg font-semibold mb-4 text-brand-text">Spending by Category</h3>
                <div class="relative h-72 flex items-center justify-center">
                    <canvas id="donutChart"></canvas>
                    <div id="donutCenter" class="chart-center-text text-center">
                        <p class="text-3xl font-bold gradient-text">₹0</p>
                        <p class="text-brand-text/60 text-sm">Total Spent</p>
                    </div>
                </div>
            </div>

            <!-- Bar Chart -->
            <div class="glass-card rounded-2xl p-6 hover-scale animate-fade-in" style="animation-delay: 0.3s">
                <h3 class="text-lg font-semibold mb-4 text-brand-text">Budget vs Actual</h3>
                <div class="h-72">
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <!-- Line Chart (Full Width) -->
            <div class="lg:col-span-2 glass-card rounded-2xl p-6 hover-scale animate-fade-in"
                style="animation-delay: 0.4s">
                <h3 class="text-lg font-semibold mb-4 text-brand-text">Spending Trend (Last 6 Months)</h3>
                <div class="h-72">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Transactions Table -->
        <section class="glass-card rounded-2xl p-6 animate-fade-in" style="animation-delay: 0.5s">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                <h3 class="text-lg font-semibold text-brand-text">Recent Transactions</h3>
                <div class="flex gap-3">
                    <select id="filterAccount" onchange="renderTransactions()"
                        class="glass-input rounded-lg px-3 py-2 text-sm text-white focus:outline-none">
                        <option value="">All Accounts</option>
                    </select>
                    <select id="filterCategory" onchange="renderTransactions()"
                        class="glass-input rounded-lg px-3 py-2 text-sm text-white focus:outline-none">
                        <option value="">All Categories</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto scrollbar-thin">
                <table class="w-full">
                    <thead>
                        <tr class="text-gray-400 text-sm border-b border-white/10">
                            <th class="text-left py-3 px-4 font-medium">Date</th>
                            <th class="text-left py-3 px-4 font-medium">Category</th>
                            <th class="text-left py-3 px-4 font-medium">Sub-Category</th>
                            <th class="text-left py-3 px-4 font-medium">Account</th>
                            <th class="text-right py-3 px-4 font-medium">Amount</th>
                            <th class="text-center py-3 px-4 font-medium">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable" class="text-sm">
                        <!-- Transactions will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="noTransactions" class="hidden text-center py-12 text-gray-400">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                <p>No transactions found</p>
            </div>
        </section>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl w-full max-w-md p-6 animate-slide-up">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold gradient-text">Add Transaction</h3>
                <button onclick="closeModal('transactionModal')"
                    class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="transactionForm" onsubmit="handleTransactionSubmit(event)" class="space-y-4">
                <div class="flex gap-2 mb-4 bg-black/20 p-1 rounded-xl">
                    <button type="button" id="txTypeExpense" onclick="setTransactionType('expense')"
                        class="flex-1 py-2 text-sm font-medium rounded-lg bg-rose-500/20 text-rose-400 border border-rose-500/50 transition-all">
                        Expense
                    </button>
                    <button type="button" id="txTypeIncome" onclick="setTransactionType('income')"
                        class="flex-1 py-2 text-sm font-medium rounded-lg text-gray-400 hover:text-white transition-all">
                        Income
                    </button>
                </div>
                <input type="hidden" id="txType" value="expense">

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Amount (₹)</label>
                    <input type="number" id="txAmount" step="0.01" min="0.01" required
                        class="w-full glass-input rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none"
                        placeholder="0.00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Date</label>
                    <input type="date" id="txDate" required
                        class="w-full glass-input rounded-xl px-4 py-3 text-white focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Account</label>
                    <select id="txAccount" required
                        class="w-full glass-input rounded-xl px-4 py-3 text-white focus:outline-none">
                        <option value="">Select account</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Category</label>
                    <select id="txCategory" required onchange="updateSubCategories()"
                        class="w-full glass-input rounded-xl px-4 py-3 text-white focus:outline-none">
                        <option value="">Select category</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Sub-Category</label>
                    <select id="txSubCategory" required
                        class="w-full glass-input rounded-xl px-4 py-3 text-white focus:outline-none">
                        <option value="">Select sub-category</option>
                    </select>
                </div>
                <button type="submit"
                    class="w-full bg-brand-primary hover:bg-red-700 py-3 rounded-xl font-medium transition-all hover-scale btn-ripple text-white">
                    Add Transaction
                </button>
            </form>
        </div>
    </div>

    <!-- Budget Modal -->
    <div id="budgetModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden animate-slide-up">
            <div class="flex items-center justify-between p-6 border-b border-white/10">
                <h3 class="text-xl font-semibold gradient-text">Set Monthly Budgets</h3>
                <button onclick="closeModal('budgetModal')" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="budgetForm" onsubmit="handleBudgetSubmit(event)"
                class="p-6 overflow-y-auto scrollbar-thin max-h-[calc(80vh-140px)]">
                <div id="budgetInputs" class="space-y-4">
                    <!-- Budget inputs will be inserted here -->
                </div>
            </form>
            <div class="p-6 border-t border-white/10">
                <button type="submit" form="budgetForm"
                    class="w-full bg-brand-primary hover:bg-red-700 py-3 rounded-xl font-medium transition-all hover-scale btn-ripple text-white">
                    Save Budgets
                </button>
            </div>
        </div>
    </div>

    </div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden animate-slide-up">
            <div class="flex items-center justify-between p-6 border-b border-white/10">
                <h3 class="text-xl font-semibold gradient-text">Manage Accounts</h3>
                <button onclick="closeModal('accountModal')" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-6 overflow-y-auto scrollbar-thin max-h-[calc(80vh-80px)]">
                <!-- Add/Edit Account Form -->
                <form id="addAccountForm" onsubmit="handleAccountSubmit(event)"
                    class="mb-8 p-4 bg-white/5 rounded-xl border border-white/10">
                    <div class="flex justify-between items-center mb-3">
                        <h4 id="accountFormTitle" class="text-sm font-semibold text-gray-300 uppercase tracking-wider">
                            Add New Account</h4>
                        <button type="button" onclick="resetAccountForm()"
                            class="text-xs text-brand-primary hover:text-white">Reset</button>
                    </div>
                    <input type="hidden" id="originalAccountName">
                    <div class="space-y-4">
                        <div>
                            <input type="text" id="newAccountName" placeholder="Account Name (e.g. Chase Bank)" required
                                class="w-full glass-input rounded-xl px-4 py-2 text-white focus:outline-none text-sm">
                        </div>
                        <button type="submit" id="saveAccountBtn"
                            class="w-full bg-brand-primary hover:bg-red-700 py-2.5 rounded-xl text-sm font-medium transition-all hover-scale btn-ripple text-white mt-2">
                            Add Account
                        </button>
                    </div>
                </form>

                <!-- Existing Accounts List -->
                <h4 class="text-sm font-semibold text-gray-300 mb-3 uppercase tracking-wider">Existing Accounts</h4>
                <div id="accountList" class="space-y-3">
                    <!-- Dynamic List -->
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden animate-slide-up">
            <div class="flex items-center justify-between p-6 border-b border-white/10">
                <h3 class="text-xl font-semibold gradient-text">Manage Categories</h3>
                <button onclick="closeModal('categoryModal')" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-6 overflow-y-auto scrollbar-thin max-h-[calc(80vh-80px)]">
                <!-- Add/Edit Category Form -->
                <form id="addCategoryForm" onsubmit="handleCategorySubmit(event)"
                    class="mb-8 p-4 bg-white/5 rounded-xl border border-white/10">
                    <div class="flex justify-between items-center mb-3">
                        <h4 id="formTitle" class="text-sm font-semibold text-gray-300 uppercase tracking-wider">Add New
                            Category</h4>
                        <button type="button" onclick="resetCategoryForm()"
                            class="text-xs text-brand-primary hover:text-white">Reset</button>
                    </div>

                    <div class="flex gap-2 mb-4 bg-black/20 p-1 rounded-xl">
                        <button type="button" id="catTypeExpense" onclick="setCategoryType('expense')"
                            class="flex-1 py-2 text-sm font-medium rounded-lg bg-rose-500/20 text-rose-400 border border-rose-500/50 transition-all">
                            Expense
                        </button>
                        <button type="button" id="catTypeIncome" onclick="setCategoryType('income')"
                            class="flex-1 py-2 text-sm font-medium rounded-lg text-gray-400 hover:text-white transition-all">
                            Income
                        </button>
                    </div>
                    <input type="hidden" id="catType" value="expense">

                    <input type="hidden" id="originalCatName">
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Category Name</label>
                            <input type="text" id="newCatName" placeholder="e.g. Travel" required
                                class="w-full glass-input rounded-xl px-4 py-2 text-white focus:outline-none text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Sub-categories</label>
                            <input type="text" id="newCatSub" placeholder="Flight, Hotel, Car (comma separated)"
                                class="w-full glass-input rounded-xl px-4 py-2 text-white focus:outline-none text-sm">
                        </div>

                        <!-- Color Section -->
                        <div>
                            <label class="text-xs text-gray-400 mb-2 block">Color Theme</label>
                            <div class="flex flex-wrap gap-2 mb-3" id="colorPalette">
                                <!-- Presets generated by JS -->
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <input type="color" id="newCatColor" value="#b11f29"
                                        onchange="updateHexInput(this.value)"
                                        class="h-10 w-16 rounded cursor-pointer bg-transparent border-none p-0">
                                </div>
                                <div class="flex-1 relative">
                                    <span
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">#</span>
                                    <input type="text" id="hexInput" placeholder="B11F29" maxlength="6"
                                        oninput="updateColorFromHex(this.value)"
                                        class="w-full glass-input rounded-xl pl-7 pr-4 py-2 text-white focus:outline-none text-sm uppercase">
                                </div>
                            </div>
                        </div>

                        <button type="submit" id="saveCatBtn"
                            class="w-full bg-brand-primary hover:bg-red-700 py-2.5 rounded-xl text-sm font-medium transition-all hover-scale btn-ripple text-white mt-2">
                            Add Category
                        </button>
                    </div>
                </form>

                <!-- Existing Categories List -->
                <h4 class="text-sm font-semibold text-gray-300 mb-3 uppercase tracking-wider">Existing Categories</h4>
                <div id="categoryList" class="space-y-3">
                    <!-- Dynamic List -->
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Widget -->
    <div class="chat-widget">
        <!-- Chat Window -->
        <div id="chatWindow" class="chat-window glass-card">
            <!-- Settings Modal (Overlay) -->
            <div id="apiKeyModal"
                class="absolute inset-0 bg-[#171717] z-20 flex flex-col items-center justify-center p-6 text-center transform transition-transform duration-300 translate-y-full">
                <div class="mb-6">
                    <div class="w-12 h-12 bg-brand-primary/20 rounded-xl flex items-center justify-center mx-auto mb-4">
                        <svg class="w-6 h-6 text-brand-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">Connect AI</h3>
                    <p class="text-gray-400 text-sm">Enter your OpenAI API key to enable specific expense analysis.</p>
                </div>
                <input type="password" id="apiKeyInput" placeholder="sk-..."
                    class="w-full glass-input rounded-xl px-4 py-3 text-white mb-4 focus:outline-none">
                <button onclick="saveApiKey()"
                    class="w-full bg-brand-primary hover:bg-red-700 py-3 rounded-xl font-medium text-white transition-all btn-ripple mb-3">
                    Connect
                </button>
                <button onclick="toggleApiKeyModal()" class="text-gray-400 text-sm hover:text-white">Cancel</button>
            </div>

            <!-- Chat Header -->
            <div class="chat-header">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-brand-primary/20 flex items-center justify-center">
                        <svg class="w-4 h-4 text-brand-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-white text-sm">FinAI Assistant</h3>
                        <p class="text-xs text-green-400 flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>
                            Online
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="toggleApiKeyModal()"
                        class="p-2 text-gray-400 hover:text-white rounded-lg hover:bg-white/5 transition-colors"
                        title="Settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    <button onclick="toggleChat()"
                        class="p-2 text-gray-400 hover:text-white rounded-lg hover:bg-white/5 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="chat-messages scrollbar-thin">
                <div class="message ai">
                    Hello! I'm your financial assistant. I can help specific analysis of your spending, budget, and
                    trends. Ask me anything!
                </div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-area">
                <form onsubmit="handleChatSubmit(event)" class="relative">
                    <input type="text" id="chatInput" placeholder="Ask about your expenses..."
                        class="w-full glass-input rounded-xl pl-4 pr-12 py-3 text-white focus:outline-none text-sm">
                    <button type="submit"
                        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-brand-primary hover:text-red-500 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- Chat Button -->
        <button onclick="toggleChat()" class="chat-button glow-border">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
        </button>
    </div>

    <script>
        // Category Configuration with vibrant colors
        // Category Configuration (Loaded from Storage or Default)
        const DEFAULT_CATEGORIES = {
            'Food & Dining': {
                color: '#f472b6',
                gradient: 'from-pink-500 to-rose-500',
                subCategories: ['Groceries', 'Restaurants', 'Coffee', 'Fast Food', 'Delivery']
            },
            'Transportation': {
                color: '#60a5fa',
                gradient: 'from-blue-500 to-cyan-500',
                subCategories: ['Gas', 'Public Transit', 'Uber/Lyft', 'Parking', 'Car Maintenance']
            },
            'Entertainment': {
                color: '#a78bfa',
                gradient: 'from-purple-500 to-violet-500',
                subCategories: ['Movies', 'Games', 'Streaming', 'Events', 'Hobbies']
            },
            'Shopping': {
                color: '#fb923c',
                gradient: 'from-orange-500 to-amber-500',
                subCategories: ['Clothing', 'Electronics', 'Home', 'Personal Care', 'Gifts']
            },
            'Bills & Utilities': {
                color: '#4ade80',
                gradient: 'from-green-500 to-emerald-500',
                subCategories: ['Electric', 'Water', 'Internet', 'Phone', 'Insurance']
            },
            'Healthcare': {
                color: '#f87171',
                gradient: 'from-red-500 to-rose-500',
                subCategories: ['Doctor', 'Pharmacy', 'Dental', 'Vision', 'Fitness'],
                type: 'expense'
            }
        };

        const DEFAULT_INCOME_CATEGORIES = {
            'Salary': {
                color: '#22c55e',
                gradient: 'from-green-500 to-emerald-500',
                subCategories: ['Monthly', 'Annual', 'Other'],
                type: 'income'
            },
            'Bonus': {
                color: '#06b6d4',
                gradient: 'from-cyan-500 to-blue-500',
                subCategories: ['Performance', 'Annual', 'Other'],
                type: 'income'
            },
            'Invoice': {
                color: '#d946ef',
                gradient: 'from-fuchsia-500 to-pink-500',
                subCategories: ['Client Payment', 'Project', 'Other'],
                type: 'income'
            },
            'Gift': {
                color: '#a8a29e',
                gradient: 'from-stone-500 to-gray-500',
                subCategories: ['Birthday', 'Holiday', 'Other'],
                type: 'income'
            }
        };

        let CATEGORIES = {};

        // Accounts
        let ACCOUNTS = ['Bank 1', 'Bank 2', 'Cash']; // Default

        // State
        let transactions = [];
        let budgets = {};
        let selectedMonth = new Date().toISOString().slice(0, 7);
        let donutChart, barChart, lineChart, balanceSparkline, incomeSparkline, expenseSparkline;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            populateMonthSelect();
            populateCategorySelects();
            populateAccountSelects();
            initCharts();
            initSparklines();
            renderAll();
            setDefaultDate();
        });

        // Account Logic
        function populateAccountSelects() {
            const selects = ['txAccount', 'filterAccount'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;

                // Keep first option (placeholder)
                const firstOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(firstOption);

                ACCOUNTS.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc;
                    option.textContent = acc;
                    select.appendChild(option);
                });
            });
        }

        function handleAccountSubmit(e) {
            e.preventDefault();
            const originalName = document.getElementById('originalAccountName').value;
            const name = document.getElementById('newAccountName').value.trim();

            if (!name) return;

            // Check if exists
            if (name !== originalName && ACCOUNTS.includes(name)) {
                alert('Account name already exists!');
                return;
            }

            if (originalName && originalName !== name) {
                // Rename logic
                if (confirm(`Rename account from "${originalName}" to "${name}"? This will update all associated transactions.`)) {
                    // Update list
                    const index = ACCOUNTS.indexOf(originalName);
                    if (index !== -1) ACCOUNTS[index] = name;

                    // Update transactions
                    transactions.forEach(t => {
                        if (t.account === originalName) t.account = name;
                    });
                } else {
                    return;
                }
            } else if (!originalName) {
                // Add new
                ACCOUNTS.push(name);
            }

            saveData();
            saveAccounts();

            resetAccountForm();
            renderAccountList();
            populateAccountSelects();
            renderAll();
        }

        function editAccount(name) {
            document.getElementById('accountFormTitle').innerText = 'Edit Account';
            document.getElementById('saveAccountBtn').innerText = 'Save Changes';
            document.getElementById('originalAccountName').value = name;
            document.getElementById('newAccountName').value = name;
        }

        function deleteAccount(name) {
            if (confirm(`Delete account "${name}"? This might leave orphaned transactions.`)) {
                ACCOUNTS = ACCOUNTS.filter(a => a !== name);
                saveAccounts();
                renderAccountList();
                populateAccountSelects();
                renderAll();
            }
        }

        function resetAccountForm() {
            document.getElementById('addAccountForm').reset();
            document.getElementById('originalAccountName').value = '';
            document.getElementById('accountFormTitle').innerText = 'Add New Account';
            document.getElementById('saveAccountBtn').innerText = 'Add Account';
        }

        function renderAccountList() {
            const list = document.getElementById('accountList');
            list.innerHTML = ACCOUNTS.map(name => `
                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5 table-row-hover">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-brand-primary/20 flex items-center justify-center border border-white/10">
                            <span class="text-brand-primary text-xs font-bold">${name.substring(0, 2).toUpperCase()}</span>
                        </div>
                        <p class="font-medium text-white text-sm">${name}</p>
                    </div>
                    <div class="flex items-center gap-2">
                         <button onclick="editAccount('${name}')" class="text-gray-400 hover:text-brand-primary p-2 rounded-lg hover:bg-white/5 transition-colors" title="Edit">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button onclick="deleteAccount('${name}')" class="text-gray-400 hover:text-red-500 p-2 rounded-lg hover:bg-white/5 transition-colors" title="Delete">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Data Management
        function loadData() {
            try {
                const savedTransactions = localStorage.getItem('expenseTracker_transactions');
                const savedBudgets = localStorage.getItem('expenseTracker_budgets');
                const savedCategories = localStorage.getItem('expenseTracker_categories');
                const savedAccounts = localStorage.getItem('expenseTracker_accounts');

                if (savedCategories) {
                    try {
                        CATEGORIES = JSON.parse(savedCategories);
                        // Migration: Ensure type exists for old categories
                        Object.values(CATEGORIES).forEach(c => {
                            if (!c.type) c.type = 'expense';
                        });

                        // Ensure income categories exist - add them if missing
                        const incomeCategories = Object.keys(DEFAULT_INCOME_CATEGORIES);
                        const hasIncomeCategories = incomeCategories.some(cat => CATEGORIES[cat]);

                        if (!hasIncomeCategories) {
                            Object.assign(CATEGORIES, JSON.parse(JSON.stringify(DEFAULT_INCOME_CATEGORIES)));
                            saveCategories();
                        }
                    } catch (e) {
                        console.error('Error parsing categories:', e);
                        // Fallback to default
                        CATEGORIES = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
                        Object.assign(CATEGORIES, JSON.parse(JSON.stringify(DEFAULT_INCOME_CATEGORIES)));
                        saveCategories();
                    }
                } else {
                    CATEGORIES = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
                    Object.assign(CATEGORIES, JSON.parse(JSON.stringify(DEFAULT_INCOME_CATEGORIES)));
                    saveCategories();
                }

                if (savedAccounts) {
                    try {
                        ACCOUNTS = JSON.parse(savedAccounts);
                    } catch (e) {
                        console.error('Error parsing accounts:', e);
                        saveAccounts(); // Re-save defaults
                    }
                } else {
                    saveAccounts();
                }

                if (savedTransactions) {
                    try {
                        transactions = JSON.parse(savedTransactions);
                        // Ensure it's an array
                        if (!Array.isArray(transactions)) transactions = [];
                    } catch (e) {
                        console.error('Error parsing transactions:', e);
                        // Recover by resetting or keeping empty? 
                        // Safer to keep empty or load sample if confirmed corruption. 
                        // Let's load sample if it fails, to show something.
                        loadSampleData();
                    }
                } else {
                    loadSampleData();
                }

                if (savedBudgets) {
                    try {
                        budgets = JSON.parse(savedBudgets);
                    } catch (e) {
                        console.error('Error parsing budgets:', e);
                        initDefaultBudgets(); // Re-initialize defaults
                    }
                } else {
                    initDefaultBudgets();
                }
            } catch (error) {
                console.error('Critical error loading data:', error);
                // Last resort fallback
                loadSampleData();
                initDefaultBudgets();
            }
        }

        function saveCategories() {
            localStorage.setItem('expenseTracker_categories', JSON.stringify(CATEGORIES));
        }

        function saveAccounts() {
            localStorage.setItem('expenseTracker_accounts', JSON.stringify(ACCOUNTS));
        }

        const PRESET_COLORS = [
            '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#22c55e',
            '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#f43f5e'
        ];

        function initColorPalette() {
            const container = document.getElementById('colorPalette');
            if (!container) return;
            container.innerHTML = PRESET_COLORS.map(color => `
                <button type="button" onclick="selectColor('${color}')" 
                    class="w-6 h-6 rounded-full hover:scale-125 transition-transform border border-white/20"
                    style="background-color: ${color};" title="${color}">
                </button>
            `).join('');
            updateHexInput(document.getElementById('newCatColor').value);
        }

        function selectColor(color) {
            document.getElementById('newCatColor').value = color;
            updateHexInput(color);
        }

        function updateHexInput(color) {
            document.getElementById('hexInput').value = color.replace('#', '').toUpperCase();
        }

        function updateColorFromHex(hex) {
            if (/^[0-9A-Fa-f]{6}$/.test(hex)) {
                document.getElementById('newCatColor').value = '#' + hex;
            }
        }

        function handleCategorySubmit(e) {
            e.preventDefault();
            const originalName = document.getElementById('originalCatName').value;
            const name = document.getElementById('newCatName').value.trim();
            const sub = document.getElementById('newCatSub').value.trim();
            const color = document.getElementById('newCatColor').value;

            if (!name) return;

            // Check if name taken (unless it's the same category we're editing)
            if (name !== originalName && CATEGORIES[name]) {
                alert('Category name already exists!');
                return;
            }

            const subCategories = sub ? sub.split(',').map(s => s.trim()).filter(s => s) : ['General'];
            const newCategoryData = {
                color: color,
                gradient: `from-[${color}] to-[${color}]`, // Simple gradient fallback
                subCategories: subCategories
            };

            if (originalName && originalName !== name) {
                // Rename logic: Migrate data
                if (confirm(`Rename category from "${originalName}" to "${name}"? This will update all associated transactions.`)) {
                    // Update transactions
                    transactions.forEach(t => {
                        if (t.category === originalName) t.category = name;
                    });

                    // Update budgets
                    if (budgets[originalName]) {
                        budgets[name] = budgets[originalName];
                        delete budgets[originalName];
                    }

                    delete CATEGORIES[originalName];
                    CATEGORIES[name] = newCategoryData;
                } else {
                    return; // Cancelled
                }
            } else {
                // Create or Update (same name)
                CATEGORIES[name] = newCategoryData;
            }

            saveData(); // Saves transactions/budgets too
            saveCategories();

            resetCategoryForm();
            renderCategoryList();
            populateCategorySelects();
            renderAll();
        }

        function editCategory(name) {
            const data = CATEGORIES[name];
            if (!data) return;

            document.getElementById('formTitle').innerText = 'Edit Category';
            document.getElementById('saveCatBtn').innerText = 'Save Changes';
            document.getElementById('originalCatName').value = name;

            document.getElementById('newCatName').value = name;
            document.getElementById('newCatSub').value = data.subCategories.join(', ');
            document.getElementById('newCatColor').value = data.color;
            updateHexInput(data.color);

            // Scroll form into view
            document.getElementById('addCategoryForm').scrollIntoView({ behavior: 'smooth' });
        }

        function resetCategoryForm() {
            document.getElementById('addCategoryForm').reset();
            document.getElementById('originalCatName').value = '';
            document.getElementById('formTitle').innerText = 'Add New Category';
            document.getElementById('saveCatBtn').innerText = 'Add Category';
            updateHexInput('#b11f29');
        }

        function deleteCategory(name) {
            if (confirm(`Delete category "${name}"? Transactions will effectively be orphaned.`)) {
                delete CATEGORIES[name];
                saveCategories();
                renderCategoryList();
                populateCategorySelects();
                renderAll();
            }
        }

        function renderCategoryList() {
            const list = document.getElementById('categoryList');
            // Ensure color palette is initialized when list is rendered (or modal opened)
            initColorPalette();

            list.innerHTML = Object.entries(CATEGORIES).map(([name, data]) => `
                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5 table-row-hover">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full border border-white/10" style="background-color: ${data.color}"></div>
                        <div>
                            <p class="font-medium text-white text-sm">${name}</p>
                            <p class="text-xs text-gray-500">${data.subCategories.length} sub-categories</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <button onclick="editCategory('${name}')" class="text-gray-400 hover:text-brand-primary p-2 rounded-lg hover:bg-white/5 transition-colors" title="Edit">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button onclick="deleteCategory('${name}')" class="text-gray-400 hover:text-red-500 p-2 rounded-lg hover:bg-white/5 transition-colors" title="Delete">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function saveData() {
            localStorage.setItem('expenseTracker_transactions', JSON.stringify(transactions));
            localStorage.setItem('expenseTracker_budgets', JSON.stringify(budgets));
        }

        function loadSampleData() {
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);

            transactions = [
                { id: 1, amount: 85.50, date: `${currentMonth}-05`, account: 'Bank 1', category: 'Food & Dining', subCategory: 'Groceries' },
                { id: 2, amount: 45.00, date: `${currentMonth}-08`, account: 'Cash', category: 'Entertainment', subCategory: 'Movies' },
                { id: 3, amount: 120.00, date: `${currentMonth}-10`, account: 'Bank 2', category: 'Bills & Utilities', subCategory: 'Electric' },
                { id: 4, amount: 65.99, date: `${currentMonth}-12`, account: 'Bank 1', category: 'Shopping', subCategory: 'Clothing' },
                { id: 5, amount: 35.00, date: `${currentMonth}-15`, account: 'Cash', category: 'Transportation', subCategory: 'Gas' },
            ];

            // Add some historical data for the trend chart
            for (let i = 1; i <= 5; i++) {
                const pastDate = new Date(today.getFullYear(), today.getMonth() - i, 15);
                const pastMonth = pastDate.toISOString().slice(0, 7);
                const categories = Object.keys(CATEGORIES);

                categories.forEach((cat, idx) => {
                    transactions.push({
                        id: transactions.length + 1,
                        amount: Math.floor(Math.random() * 150) + 50,
                        date: `${pastMonth}-${10 + idx}`,
                        account: ['Bank 1', 'Bank 2', 'Cash'][idx % 3],
                        category: cat,
                        subCategory: CATEGORIES[cat].subCategories[0]
                    });
                });
            }

            saveData();
        }

        function initDefaultBudgets() {
            Object.entries(CATEGORIES).forEach(([cat, data]) => {
                // Only create budgets for expense categories
                if (data.type !== 'income') {
                    budgets[cat] = 200;
                }
            });
            saveData();
        }

        // Month Selection
        function populateMonthSelect() {
            const select = document.getElementById('monthSelect');
            const today = new Date();

            for (let i = 0; i < 12; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const value = date.toISOString().slice(0, 7);
                const label = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                const option = document.createElement('option');
                option.value = value;
                option.textContent = label;
                if (value === selectedMonth) option.selected = true;
                select.appendChild(option);
            }
        }

        function changeMonth() {
            selectedMonth = document.getElementById('monthSelect').value;
            renderAll();
        }

        // Category Selects
        function populateCategorySelects() {
            const txCategorySelect = document.getElementById('txCategory');
            const filterCategorySelect = document.getElementById('filterCategory');
            const currentType = document.getElementById('txType') ? document.getElementById('txType').value : 'expense';

            // Clear and rebuild txCategory (transaction form) - filter by type
            const txPlaceholder = txCategorySelect.options[0].cloneNode(true);
            txCategorySelect.innerHTML = '';
            txCategorySelect.appendChild(txPlaceholder);

            Object.entries(CATEGORIES).forEach(([cat, data]) => {
                const catType = data.type || 'expense';
                // Only show categories matching the selected transaction type
                if (catType === currentType) {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    txCategorySelect.appendChild(option);
                }
            });

            // Clear and rebuild filterCategory (show all categories)
            const filterPlaceholder = filterCategorySelect.options[0].cloneNode(true);
            filterCategorySelect.innerHTML = '';
            filterCategorySelect.appendChild(filterPlaceholder);

            Object.keys(CATEGORIES).forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                filterCategorySelect.appendChild(option);
            });
        }

        function updateSubCategories() {
            const category = document.getElementById('txCategory').value;
            const subCategorySelect = document.getElementById('txSubCategory');

            subCategorySelect.innerHTML = '<option value="">Select sub-category</option>';

            if (category && CATEGORIES[category]) {
                CATEGORIES[category].subCategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subCategorySelect.appendChild(option);
                });
            }
        }

        // Modal Management
        function openModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            if (id === 'budgetModal') {
                renderBudgetInputs();
            }
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        function setDefaultDate() {
            document.getElementById('txDate').value = new Date().toISOString().slice(0, 10);
        }

        // Transaction Management
        function handleTransactionSubmit(e) {
            e.preventDefault();

            const type = document.getElementById('txType').value;
            const category = document.getElementById('txCategory').value;

            const newTransaction = {
                id: Date.now(),
                amount: parseFloat(document.getElementById('txAmount').value),
                date: document.getElementById('txDate').value,
                account: document.getElementById('txAccount').value,
                category: category,
                subCategory: document.getElementById('txSubCategory').value,
                type: type || 'expense',
                desc: category // Fallback description
            };

            transactions.push(newTransaction);
            saveData();
            renderAll(); // Will update totals
            closeModal('transactionModal');
            document.getElementById('transactionForm').reset();

            // Reset state
            setTransactionType('expense');
            setDefaultDate();
        }

        function setTransactionType(type) {
            document.getElementById('txType').value = type;
            const expenseBtn = document.getElementById('txTypeExpense');
            const incomeBtn = document.getElementById('txTypeIncome');

            if (type === 'expense') {
                expenseBtn.className = "flex-1 py-2 text-sm font-medium rounded-lg bg-rose-500/20 text-rose-400 border border-rose-500/50 transition-all";
                incomeBtn.className = "flex-1 py-2 text-sm font-medium rounded-lg text-gray-400 hover:text-white transition-all";
            } else {
                incomeBtn.className = "flex-1 py-2 text-sm font-medium rounded-lg bg-emerald-500/20 text-emerald-400 border border-emerald-500/50 transition-all";
                expenseBtn.className = "flex-1 py-2 text-sm font-medium rounded-lg text-gray-400 hover:text-white transition-all";
            }
            populateCategorySelects();
        }

        function setCategoryType(type) {
            document.getElementById('catType').value = type;
            const expenseBtn = document.getElementById('catTypeExpense');
            const incomeBtn = document.getElementById('catTypeIncome');

            if (type === 'expense') {
                expenseBtn.className = "flex-1 py-2 text-sm font-medium rounded-lg bg-rose-500/20 text-rose-400 border border-rose-500/50 transition-all";
                incomeBtn.className = "flex-1 py-2 text-sm font-medium rounded-lg text-gray-400 hover:text-white transition-all";
            } else {
                incomeBtn.className = "flex-1 py-2 text-sm font-medium rounded-lg bg-emerald-500/20 text-emerald-400 border border-emerald-500/50 transition-all";
                expenseBtn.className = "flex-1 py-2 text-sm font-medium rounded-lg text-gray-400 hover:text-white transition-all";
            }
        }

        function deleteTransaction(id) {
            if (confirm('Delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                renderAll();
            }
        }

        // Budget Management
        function renderBudgetInputs() {
            const container = document.getElementById('budgetInputs');
            container.innerHTML = '';

            Object.entries(CATEGORIES).forEach(([cat, data]) => {
                // Only show expense categories for budgets
                if (data.type === 'income') return;

                const div = document.createElement('div');
                div.className = 'flex items-center gap-4';
                div.innerHTML = `
                    <div class="w-3 h-3 rounded-full" style="background: ${CATEGORIES[cat].color}"></div>
                    <label class="flex-1 text-gray-300">${cat}</label>
                    <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">₹</span>
                        <input type="number" name="${cat}" value="${budgets[cat] || 0}" min="0" step="10"
                            class="w-32 glass-input rounded-lg pl-7 pr-3 py-2 text-white focus:outline-none text-right">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function handleBudgetSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            Object.keys(CATEGORIES).forEach(cat => {
                budgets[cat] = parseFloat(formData.get(cat)) || 0;
            });

            saveData();
            renderAll();
            closeModal('budgetModal');
        }

        // Calculate spending for a specific month (EXPENSES ONLY)
        function getMonthlySpending(month) {
            const spending = {};
            // Only initialize expense categories
            Object.entries(CATEGORIES).forEach(([cat, data]) => {
                if (data.type !== 'income') {
                    spending[cat] = 0;
                }
            });

            transactions
                .filter(t => t.date.startsWith(month))
                .filter(t => (t.type || 'expense') !== 'income') // Filter out income transactions
                .forEach(t => {
                    if (spending[t.category] !== undefined) {
                        spending[t.category] += t.amount;
                    }
                });

            return spending;
        }

        // Render All Components
        function renderAll() {
            const month = document.getElementById('monthSelect').value;
            const monthTransactions = transactions.filter(t => t.date.substring(0, 7) === month);

            // Calculate Totals
            let income = 0;
            let expense = 0;

            monthTransactions.forEach(t => {
                // Determine type: check transaction.type first, then category.type as fallback
                const categoryData = CATEGORIES[t.category];
                const txType = t.type || (categoryData && categoryData.type) || 'expense';

                if (txType === 'income') income += t.amount;
                else expense += t.amount;
            });

            // Update Summary Cards
            updateSummaryCards(income, expense);

            // Render Components
            // Note: renderBudgetCards and updateCharts should ideally only show EXPENSES
            // logic inside them needs to be aware or we pass filtered data. 
            // Existing functions use GLOBAL variables or internal filtering.
            // Let's pass filtering implicitly by reliance on Global `selectedMonth`. 
            // BUT we need to update them to filter out income usually.

            renderBudgetCards();
            renderTransactions();
            updateCharts();
            checkOverspending();
        }

        function updateSummaryCards(totalIncome, totalExpense) {
            const balance = totalIncome - totalExpense;

            // Helper to animate numbers
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.innerText = `₹${val.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            };

            setVal('totalBalance', balance);
            setVal('totalIncome', totalIncome);
            setVal('totalExpenseSummary', totalExpense);

            // Update Sparklines
            const updateSpark = (chart, data) => {
                if (!chart) return;
                chart.data.labels = data.map((_, i) => i + 1); // Simple index labels
                chart.data.datasets[0].data = data;
                chart.update('none'); // Efficient update
            };

            const month = document.getElementById('monthSelect').value;
            if (balanceSparkline) {
                updateSpark(balanceSparkline, getDailyHistory(month, 'balance'));
                updateSpark(incomeSparkline, getDailyHistory(month, 'income'));
                updateSpark(expenseSparkline, getDailyHistory(month, 'expense'));
            }
            setVal('donutCenter', totalExpense);
        }

        // Budget Cards
        function renderBudgetCards() {
            const container = document.getElementById('budgetCardsGrid');
            container.innerHTML = '';

            const spending = getMonthlySpending(selectedMonth);

            Object.keys(CATEGORIES).forEach((cat, index) => {
                const budget = budgets[cat] || 0;
                const spent = spending[cat] || 0;
                const percentage = budget > 0 ? (spent / budget) * 100 : 0;
                const diff = budget - spent;
                const isOver = diff < 0;
                const staggerClass = `stagger-${Math.min(index + 1, 6)}`;

                const card = document.createElement('div');
                card.className = `glass-card rounded-xl p-5 hover-scale glow-border animate-fade-in ${staggerClass}`;
                card.innerHTML = `
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-3 h-3 rounded-full" style="background: ${CATEGORIES[cat].color}"></div>
                        <h4 class="font-medium text-gray-200 truncate">${cat}</h4>
                    </div>
                    <div class="flex justify-between items-end mb-3">
                        <div>
                            <p class="text-2xl font-bold text-white">₹${spent.toFixed(0)}</p>
                            <p class="text-xs text-gray-400">of ₹${budget} budget</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium ${isOver ? 'text-red-400' : 'text-green-400'}">
                                ${isOver ? '+' : '-'}₹${Math.abs(diff).toFixed(0)}
                            </p>
                            <p class="text-xs ${isOver ? 'text-red-400' : 'text-green-400'}">
                                ${percentage.toFixed(0)}% ${isOver ? 'over' : 'used'}
                            </p>
                        </div>
                    </div>
                    <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full progress-bar rounded-full transition-all ${isOver ? 'bg-gradient-to-r from-red-500 to-orange-500' : `bg-gradient-to-r ${CATEGORIES[cat].gradient}`}"
                            style="width: ${Math.min(percentage, 100)}%"></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Transactions Table
        function renderTransactions() {
            const tbody = document.getElementById('transactionsTable');
            const noData = document.getElementById('noTransactions');
            const filterAccount = document.getElementById('filterAccount').value;
            const filterCategory = document.getElementById('filterCategory').value;

            let filtered = transactions
                .filter(t => t.date.startsWith(selectedMonth))
                .filter(t => !filterAccount || t.account === filterAccount)
                .filter(t => !filterCategory || t.category === filterCategory)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                tbody.innerHTML = '';
                noData.classList.remove('hidden');
                return;
            }

            noData.classList.add('hidden');
            tbody.innerHTML = filtered.map((t, index) => {
                const catData = CATEGORIES[t.category];
                const catColor = catData ? catData.color : '#888';
                // Infer type from category if not set on transaction
                const txType = t.type || (catData && catData.type) || 'expense';
                const isIncome = txType === 'income';
                const sign = isIncome ? '+' : '-';
                const amountColor = isIncome ? 'text-emerald-400' : 'text-brand-text';

                return `
                <tr class="border-b border-white/5 table-row-hover animate-fade-in stagger-${Math.min(index + 1, 6)}">
                    <td class="py-4 px-4 text-brand-text/80">${new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td>
                    <td class="py-4 px-4">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full" style="background: ${catColor}"></div>
                            <span class="text-brand-text">${t.category}</span>
                        </div>
                    </td>
                    <td class="py-4 px-4 text-brand-text/60">${t.subCategory || ''}</td>
                    <td class="py-4 px-4">
                        <span class="px-2 py-1 rounded-lg text-xs font-medium bg-white/10 text-brand-text/80">${t.account}</span>
                    </td>
                    <td class="py-4 px-4 text-right font-medium ${amountColor}">${sign}₹${t.amount.toFixed(2)}</td>
                    <td class="py-4 px-4 text-center">
                        <button onclick="deleteTransaction(${t.id})" class="text-brand-text/50 hover:text-red-400 transition-colors delete-shake">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        // Sparklines Initialization
        function initSparklines() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: { x: { display: false }, y: { display: false } },
                elements: { point: { radius: 0 }, line: { borderWidth: 2, tension: 0.4 } },
                layout: { padding: 0 },
                animation: { duration: 1000, easing: 'easeOutQuart' }
            };

            const createSparkline = (id, color) => {
                const ctx = document.getElementById(id);
                if (!ctx) return null;
                return new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: color, backgroundColor: color + '20', fill: true }] },
                    options: commonOptions
                });
            };

            balanceSparkline = createSparkline('balanceSparkline', '#3b82f6');
            incomeSparkline = createSparkline('incomeSparkline', '#10b981');
            expenseSparkline = createSparkline('expenseSparkline', '#f43f5e');
        }

        function getDailyHistory(month, type) {
            const [year, mon] = month.split('-').map(Number);
            const daysInMonth = new Date(year, mon, 0).getDate();
            const history = new Array(daysInMonth).fill(0);

            // Get transactions for this month
            const monthTx = transactions.filter(t => t.date.startsWith(month));

            if (type === 'balance') {
                let runningBalance = 0;
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayStr = `${month}-${String(i).padStart(2, '0')}`;
                    const dayTx = monthTx.filter(t => t.date === dayStr);

                    const dayIncome = dayTx.filter(t => {
                        const tType = t.type || CATEGORIES[t.category]?.type || 'expense';
                        return tType === 'income';
                    }).reduce((sum, t) => sum + t.amount, 0);

                    const dayExpense = dayTx.filter(t => {
                        const tType = t.type || CATEGORIES[t.category]?.type || 'expense';
                        return tType !== 'income';
                    }).reduce((sum, t) => sum + t.amount, 0);

                    runningBalance += (dayIncome - dayExpense);
                    history[i - 1] = runningBalance;
                }
            } else {
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayStr = `${month}-${String(i).padStart(2, '0')}`;
                    const dayTx = monthTx.filter(t => t.date === dayStr);

                    const total = dayTx
                        .filter(t => {
                            const tType = t.type || CATEGORIES[t.category]?.type || 'expense';
                            return type === 'income' ? tType === 'income' : tType !== 'income';
                        })
                        .reduce((sum, t) => sum + t.amount, 0);

                    history[i - 1] = total;
                }
            }
            return history;
        }

        // Charts
        function initCharts() {
            Chart.defaults.color = 'rgba(255,255,255,0.6)';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';

            // Get expense categories only for charts
            const expenseCategories = Object.entries(CATEGORIES)
                .filter(([_, data]) => data.type !== 'income')
                .reduce((acc, [name, data]) => ({ ...acc, [name]: data }), {});

            // Donut Chart
            const donutCtx = document.getElementById('donutChart').getContext('2d');
            donutChart = new Chart(donutCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenseCategories),
                    datasets: [{
                        data: [],
                        backgroundColor: Object.values(expenseCategories).map(c => c.color),
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });

            // Bar Chart
            const barCtx = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(expenseCategories).map(c => c.split(' ')[0]),
                    datasets: [
                        {
                            label: 'Actual',
                            data: [],
                            backgroundColor: Object.values(expenseCategories).map(c => c.color),
                            borderRadius: 6,
                            barThickness: 20
                        },
                        {
                            label: 'Budget',
                            data: [],
                            backgroundColor: 'rgba(255,255,255,0.2)',
                            borderRadius: 6,
                            barThickness: 20
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    }
                }
            });

            // Line Chart
            const lineCtx = document.getElementById('lineChart').getContext('2d');
            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Monthly Spending',
                        data: [],
                        borderColor: '#b11f29',
                        backgroundColor: 'rgba(177,31,41,0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#b11f29',
                        pointBorderColor: '#dbd6cb',
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateCharts() {
            // Filter for expense categories only
            const expenseCategories = Object.entries(CATEGORIES)
                .filter(([_, data]) => data.type !== 'income')
                .reduce((acc, [name, data]) => ({ ...acc, [name]: data }), {});

            const labels = Object.keys(expenseCategories);
            const colors = Object.values(expenseCategories).map(c => c.color);

            const spending = getMonthlySpending(selectedMonth);
            // Map spending to the filtered labels
            const spendingValues = labels.map(cat => spending[cat] || 0);
            const budgetValues = labels.map(cat => budgets[cat] || 0);
            const totalSpent = spendingValues.reduce((a, b) => a + b, 0);

            // Update donut chart
            donutChart.data.labels = labels;
            donutChart.data.datasets[0].data = spendingValues;
            donutChart.data.datasets[0].backgroundColor = colors;
            donutChart.update();

            document.getElementById('donutCenter').innerHTML = `
                <p class="text-3xl font-bold gradient-text">₹${totalSpent.toFixed(0)}</p>
                <p class="text-brand-text/60 text-sm">Total Spent</p>
            `;

            // Update bar chart
            barChart.data.labels = labels.map(c => c.split(' ')[0]);
            barChart.data.datasets[0].data = spendingValues;
            barChart.data.datasets[0].backgroundColor = colors;
            barChart.data.datasets[1].data = budgetValues;
            barChart.update();

            // Update line chart (last 6 months)
            const months = [];
            const monthlyTotals = [];
            const today = new Date();

            for (let i = 5; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthKey = date.toISOString().slice(0, 7);
                const label = date.toLocaleDateString('en-US', { month: 'short' });
                const monthSpending = getMonthlySpending(monthKey);
                const total = Object.values(monthSpending).reduce((a, b) => a + b, 0);

                months.push(label);
                monthlyTotals.push(total);
            }

            lineChart.data.labels = months;
            lineChart.data.datasets[0].data = monthlyTotals;
            lineChart.update();
        }

        // Overspending Alert
        function checkOverspending() {
            const spending = getMonthlySpending(selectedMonth);
            const overspent = [];

            Object.keys(CATEGORIES).forEach(cat => {
                const budget = budgets[cat] || 0;
                const spent = spending[cat] || 0;
                if (budget > 0 && spent > budget) {
                    overspent.push(`${cat} (+$${(spent - budget).toFixed(0)})`);
                }
            });

            const banner = document.getElementById('alertBanner');
            const alertText = document.getElementById('alertText');

            if (overspent.length > 0) {
                alertText.textContent = `⚠️ Overspending Alert: ${overspent.join(', ')}`;
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }
        }

        function closeAlert() {
            document.getElementById('alertBanner').classList.add('hidden');
        }

        // Close modals on outside click
        document.querySelectorAll('[id$="Modal"]').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });
        // Initialize
        // Initialize
        // Load data FIRST, then init charts
        loadData();
        initCharts();

        // Initial Render
        renderCategoryList();
        populateMonthSelect();
        populateCategorySelects();
        renderAll();

        // AI Chat Logic
        let apiKey = localStorage.getItem('openai_api_key');
        const chatMessages = document.getElementById('chatMessages');

        function toggleChat() {
            document.getElementById('chatWindow').classList.toggle('open');
            if (document.getElementById('chatWindow').classList.contains('open') && !apiKey) {
                setTimeout(() => toggleApiKeyModal(true), 300);
            }
        }

        function toggleApiKeyModal(show = null) {
            const modal = document.getElementById('apiKeyModal');
            if (show === true) modal.classList.remove('translate-y-full');
            else if (show === false) modal.classList.add('translate-y-full');
            else modal.classList.toggle('translate-y-full');
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            if (input.value.trim()) {
                apiKey = input.value.trim();
                localStorage.setItem('openai_api_key', apiKey);
                toggleApiKeyModal(false);
                addMessage('ai', 'API Key saved! I can now analyze your data.');
            }
        }

        function addMessage(type, text) {
            const div = document.createElement('div');
            div.className = `message ${type} animate-fade-in`;
            div.innerHTML = text;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addMessage('user', message);
            input.value = '';

            if (!apiKey) {
                addMessage('ai', 'Please connect your OpenAI API key in settings to continue.');
                toggleApiKeyModal(true);
                return;
            }

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai typing-indicator';
            typingDiv.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Prepare context
                const context = {
                    transactions: transactions,
                    budgets: budgets,
                    categories: CATEGORIES,
                    currentMonth: selectedMonth,
                    totalSpent: document.getElementById('donutCenter').innerText
                };

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            {
                                role: "system",
                                content: `You are a financial assistant for a personal expense tracker. 
                                Current Data Context: ${JSON.stringify(context)}. 
                                Currency is Rupees (₹). Analyze the user's spending, budget status, and trends. 
                                Keep answers concise, helpful, and friendly. Use bolding for amounts.`
                            },
                            { role: "user", content: message }
                        ]
                    })
                });

                const data = await response.json();

                // Remove typing indicator
                if (chatMessages.contains(typingDiv)) {
                    chatMessages.removeChild(typingDiv);
                }

                if (data.error) {
                    addMessage('ai', `Error: ${data.error.message}`);
                } else {
                    const reply = data.choices[0].message.content.replace(/\n/g, '<br>');
                    addMessage('ai', reply);
                }
            } catch (error) {
                if (chatMessages.contains(typingDiv)) {
                    chatMessages.removeChild(typingDiv);
                }
                addMessage('ai', 'Sorry, I encountered an error connecting to the AI service.');
                console.error(error);
            }
        }
    </script>
</body>

</html>